<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XP Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background: linear-gradient(135deg, #a8a8a8 0%, #8a8a7a 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 20px 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .hamburger {
            display: flex;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
            padding: 8px;
        }

        .hamburger-line {
            width: 24px;
            height: 3px;
            background: #666;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .app-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .menu-dropdown {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            display: none;
        }

        .menu-dropdown.active {
            display: block;
        }

        .menu-item {
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 600;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: #f8f9fa;
        }

        .menu-item:active {
            background: #e9ecef;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .category-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .add-behavior-btn {
            background: #7a7a7a;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .behavior-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .behavior-info {
            flex: 1;
        }

        .behavior-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .behavior-points {
            font-size: 13px;
            color: #7a7a7a;
            font-weight: 600;
        }

        .log-btn {
            background: #7a7a7a;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .log-btn:disabled {
            background: #ddd;
            color: #999;
        }

        .log-btn.logged {
            background: #6b8e6b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
        }

        .form-input:focus {
            outline: none;
            border-color: #7a7a7a;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
        }

        .btn-primary {
            background: #7a7a7a;
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .chart-container {
            height: 250px;
            margin-top: 20px;
            position: relative;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 200px;
            gap: 4px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(180deg, #7a7a7a 0%, #5a5a5a 100%);
            border-radius: 6px 6px 0 0;
            position: relative;
            min-height: 2px;
            transition: all 0.3s ease;
        }

        .chart-label {
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #666;
            white-space: nowrap;
        }

        .chart-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            color: #7a7a7a;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #333;
        }

        .analytics-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .analytics-tab {
            flex: 1;
            padding: 10px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .analytics-tab.active {
            background: #7a7a7a;
            color: white;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .history-date {
            font-weight: 600;
            color: #333;
        }

        .history-behaviors {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .history-xp {
            font-weight: 700;
            color: #7a7a7a;
        }

        .edit-btn {
            background: #7a7a7a;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
        }

        .delete-btn {
            background: #f56565;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="hamburger" onclick="toggleMenu()">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
            <div class="app-title">XP Tracker</div>
        </div>

        <div class="menu-dropdown" id="menuDropdown">
            <div class="menu-item" onclick="switchTab('today')">Today</div>
            <div class="menu-item" onclick="switchTab('analytics')">Analytics</div>
            <div class="menu-item" onclick="switchTab('history')">History</div>
            <div class="menu-item" onclick="switchTab('behaviors')">Behaviors</div>
            <div class="menu-item" onclick="switchTab('settings')">Settings</div>
        </div>

        <div id="todayView"></div>
        <div id="behaviorsView" style="display:none;"></div>
        <div id="analyticsView" style="display:none;"></div>
        <div id="historyView" style="display:none;"></div>
        <div id="settingsView" style="display:none;"></div>
    </div>

    <!-- Add Behavior Modal -->
    <div class="modal" id="addBehaviorModal">
        <div class="modal-content">
            <div class="modal-title">Add Behavior</div>
            <div class="form-group">
                <label class="form-label">Behavior Name</label>
                <input type="text" class="form-input" id="behaviorName" placeholder="e.g., Morning Workout">
            </div>
            <div class="form-group">
                <label class="form-label">Points</label>
                <input type="number" class="form-input" id="behaviorPoints" placeholder="e.g., 10">
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveBehavior()">Save</button>
            </div>
        </div>
    </div>

    <!-- Edit Log Modal -->
    <div class="modal" id="editLogModal">
        <div class="modal-content">
            <div class="modal-title">Edit Entry</div>
            <div id="editLogContent"></div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveLogEdit()">Save</button>
            </div>
        </div>
    </div>

    <input type="file" id="importFile" accept=".json" style="display: none;">

    <script>
        const CATEGORIES = ['Fitness', 'Diet', 'Health', 'Productivity', 'Relationships'];
        const XP_PER_LEVEL = 100;
        
        let currentCategory = '';
        let currentTab = 'today';
        let currentAnalyticsView = 'daily';
        let editingDate = '';

        // Initialize storage
        function initStorage() {
            if (!localStorage.getItem('xp_behaviors')) {
                localStorage.setItem('xp_behaviors', JSON.stringify({}));
            }
            if (!localStorage.getItem('xp_logs')) {
                localStorage.setItem('xp_logs', JSON.stringify({}));
            }
        }

        function getBehaviors() {
            try {
                const data = localStorage.getItem('xp_behaviors');
                return data ? JSON.parse(data) : {};
            } catch (error) {
                console.error('Get behaviors error:', error);
                return {};
            }
        }

        function saveBehaviors(behaviors) {
            try {
                localStorage.setItem('xp_behaviors', JSON.stringify(behaviors));
            } catch (error) {
                console.error('Save behaviors error:', error);
            }
        }

        function getLogs() {
            try {
                const data = localStorage.getItem('xp_logs');
                return data ? JSON.parse(data) : {};
            } catch (error) {
                console.error('Get logs error:', error);
                return {};
            }
        }

        function saveLogs(logs) {
            try {
                localStorage.setItem('xp_logs', JSON.stringify(logs));
            } catch (error) {
                console.error('Save logs error:', error);
            }
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.classList.toggle('active');
        }

        function calculateLevel(totalXP) {
            return Math.floor(totalXP / XP_PER_LEVEL) + 1;
        }

        function calculateProgress(totalXP) {
            const currentLevelXP = totalXP % XP_PER_LEVEL;
            return (currentLevelXP / XP_PER_LEVEL) * 100;
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Close menu
            document.getElementById('menuDropdown').classList.remove('active');

            document.getElementById('todayView').style.display = tab === 'today' ? 'block' : 'none';
            document.getElementById('behaviorsView').style.display = tab === 'behaviors' ? 'block' : 'none';
            document.getElementById('analyticsView').style.display = tab === 'analytics' ? 'block' : 'none';
            document.getElementById('historyView').style.display = tab === 'history' ? 'block' : 'none';
            document.getElementById('settingsView').style.display = tab === 'settings' ? 'block' : 'none';

            if (tab === 'today') renderToday();
            if (tab === 'behaviors') renderBehaviors();
            if (tab === 'analytics') renderAnalytics();
            if (tab === 'history') renderHistory();
            if (tab === 'settings') renderSettings();
        }

        function renderToday() {
            const behaviors = getBehaviors();
            const logs = getLogs();
            const today = getTodayString();
            const todayLogs = logs[today] || {};

            let html = '';
            let todayXP = 0;

            for (const category of CATEGORIES) {
                const categoryBehaviors = behaviors[category] || [];
                if (categoryBehaviors.length === 0) continue;

                html += `<div class="card">
                    <div class="category-header">
                        <div class="category-name">${category}</div>
                    </div>`;

                for (const behavior of categoryBehaviors) {
                    const isLogged = todayLogs[behavior.id] !== undefined;
                    if (isLogged) todayXP += behavior.points;

                    html += `<div class="behavior-item">
                        <div class="behavior-info">
                            <div class="behavior-name">${behavior.name}</div>
                            <div class="behavior-points">+${behavior.points} XP</div>
                        </div>
                        <button class="log-btn ${isLogged ? 'logged' : ''}" 
                                ${isLogged ? 'disabled' : ''} 
                                onclick="logBehavior('${behavior.id}', ${behavior.points})">
                            ${isLogged ? '✓ Done' : 'Log'}
                        </button>
                    </div>`;
                }

                html += `</div>`;
            }

            // Calculate 7-day average
            const sevenDayAvg = calculate7DayAverage(logs);
            const difference = todayXP - sevenDayAvg;
            const percentChange = sevenDayAvg > 0 ? ((difference / sevenDayAvg) * 100).toFixed(0) : 0;
            
            let comparisonHTML = '';
            if (sevenDayAvg > 0) {
                const arrow = difference > 0 ? '↑' : difference < 0 ? '↓' : '→';
                const color = difference > 0 ? '#6b8e6b' : difference < 0 ? '#a66' : '#666';
                comparisonHTML = `
                    <div style="text-align: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">vs 7-day average (${sevenDayAvg.toFixed(0)} XP)</div>
                        <div style="font-size: 16px; font-weight: 600; color: ${color};">
                            ${arrow} ${Math.abs(difference).toFixed(0)} XP (${difference >= 0 ? '+' : ''}${percentChange}%)
                        </div>
                    </div>`;
            }

            if (html === '') {
                html = `<div class="card">
                    <div class="empty-state">
                        No behaviors yet.<br>Add some in the Behaviors tab!
                    </div>
                </div>`;
            } else {
                html = `<div class="card">
                    <div class="xp-display">
                        <div class="xp-number" style="font-size: 36px;">${todayXP}</div>
                        <div class="xp-label">Today's XP</div>
                        ${comparisonHTML}
                    </div>
                </div>` + html;
            }

            document.getElementById('todayView').innerHTML = html;
        }

        function calculate7DayAverage(logs) {
            const today = new Date();
            let totalXP = 0;
            let daysWithData = 0;

            // Look at the previous 7 days (not including today)
            for (let i = 1; i <= 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayLogs = logs[dateStr] || {};
                const dayXP = Object.values(dayLogs).reduce((sum, p) => sum + p, 0);
                
                if (dayXP > 0 || Object.keys(dayLogs).length > 0) {
                    totalXP += dayXP;
                    daysWithData++;
                }
            }

            return daysWithData > 0 ? totalXP / daysWithData : 0;
        }

        function logBehavior(behaviorId, points) {
            const logs = getLogs();
            const today = getTodayString();
            
            if (!logs[today]) logs[today] = {};
            logs[today][behaviorId] = points;
            
            saveLogs(logs);
            renderToday();
        }

        function renderBehaviors() {
            const behaviors = getBehaviors();
            let html = '';

            for (const category of CATEGORIES) {
                const categoryBehaviors = behaviors[category] || [];
                
                html += `<div class="card">
                    <div class="category-header">
                        <div class="category-name">${category}</div>
                        <button class="add-behavior-btn" onclick="openAddBehaviorModal('${category}')">+ Add</button>
                    </div>`;

                if (categoryBehaviors.length === 0) {
                    html += `<div class="empty-state" style="padding: 20px;">No behaviors yet</div>`;
                } else {
                    for (const behavior of categoryBehaviors) {
                        const deleteId = `delete-${category}-${behavior.id}`;
                        html += `<div class="behavior-item">
                            <div class="behavior-info">
                                <div class="behavior-name">${behavior.name}</div>
                                <div class="behavior-points">+${behavior.points} XP</div>
                            </div>
                            <button class="delete-btn" id="${deleteId}">Delete</button>
                        </div>`;
                    }
                }

                html += `</div>`;
            }

            document.getElementById('behaviorsView').innerHTML = html;
            
            // Attach click handlers
            for (const category of CATEGORIES) {
                const categoryBehaviors = behaviors[category] || [];
                for (const behavior of categoryBehaviors) {
                    const deleteId = `delete-${category}-${behavior.id}`;
                    const btn = document.getElementById(deleteId);
                    if (btn) {
                        btn.onclick = function() {
                            deleteBehavior(category, behavior.id);
                        };
                    }
                }
            }
        }

        function openAddBehaviorModal(category) {
            currentCategory = category;
            document.getElementById('behaviorName').value = '';
            document.getElementById('behaviorPoints').value = '';
            document.getElementById('addBehaviorModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('addBehaviorModal').classList.remove('active');
        }

        function saveBehavior() {
            const name = document.getElementById('behaviorName').value.trim();
            const points = parseInt(document.getElementById('behaviorPoints').value);

            if (!name || !points || points <= 0) {
                alert('Please enter valid behavior name and points');
                return;
            }

            const behaviors = getBehaviors();
            if (!behaviors[currentCategory]) behaviors[currentCategory] = [];

            behaviors[currentCategory].push({
                id: Date.now().toString(),
                name: name,
                points: points
            });

            saveBehaviors(behaviors);
            closeModal();
            renderBehaviors();
            if (currentTab === 'today') renderToday();
        }

        function deleteBehavior(category, behaviorId) {
            const behaviors = getBehaviors();
            behaviors[category] = behaviors[category].filter(b => b.id !== behaviorId);
            saveBehaviors(behaviors);
            renderBehaviors();
            if (currentTab === 'today') renderToday();
        }

        function renderAnalytics() {
            const logs = getLogs();
            
            const records = calculateAllTimeRecords(logs);

            let html = `
                <div class="card">
                    <div class="category-name" style="margin-bottom: 16px;">All-Time Records</div>
                    <div style="display: flex; gap: 8px;">
                        <div style="flex: 1; background: #f8f9fa; border-radius: 10px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Daily</div>
                            <div style="font-size: 22px; font-weight: bold; color: #5a5a5a;">${records.daily.value}</div>
                            <div style="font-size: 10px; color: #aaa; margin-top: 4px;">${records.daily.date || '—'}</div>
                        </div>
                        <div style="flex: 1; background: #f8f9fa; border-radius: 10px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Weekly</div>
                            <div style="font-size: 22px; font-weight: bold; color: #5a5a5a;">${records.weekly.value}</div>
                            <div style="font-size: 10px; color: #aaa; margin-top: 4px;">${records.weekly.date || '—'}</div>
                        </div>
                        <div style="flex: 1; background: #f8f9fa; border-radius: 10px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Monthly</div>
                            <div style="font-size: 22px; font-weight: bold; color: #5a5a5a;">${records.monthly.value}</div>
                            <div style="font-size: 10px; color: #aaa; margin-top: 4px;">${records.monthly.date || '—'}</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="analytics-tabs">
                        <button class="analytics-tab ${currentAnalyticsView === 'daily' ? 'active' : ''}" onclick="switchAnalyticsView('daily')">Daily</button>
                        <button class="analytics-tab ${currentAnalyticsView === 'weekly' ? 'active' : ''}" onclick="switchAnalyticsView('weekly')">Weekly</button>
                        <button class="analytics-tab ${currentAnalyticsView === 'monthly' ? 'active' : ''}" onclick="switchAnalyticsView('monthly')">Monthly</button>
                    </div>
                    <div id="chartContainer"></div>
                </div>`;

            document.getElementById('analyticsView').innerHTML = html;
            renderChart(logs);
        }

        function calculateAllTimeRecords(logs) {
            const allDates = Object.keys(logs);

            // Daily record
            let bestDay = { value: 0, date: '' };
            for (const date of allDates) {
                const xp = Object.values(logs[date]).reduce((sum, p) => sum + p, 0);
                if (xp > bestDay.value) {
                    const d = new Date(date + 'T00:00:00');
                    bestDay = {
                        value: xp,
                        date: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                    };
                }
            }

            // Weekly record — find best 7-day window
            let bestWeek = { value: 0, date: '' };
            if (allDates.length > 0) {
                const sorted = [...allDates].sort();
                const first = new Date(sorted[0] + 'T00:00:00');
                const last = new Date();
                for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                    let weekXP = 0;
                    for (let i = 0; i < 7; i++) {
                        const day = new Date(d);
                        day.setDate(day.getDate() + i);
                        const dateStr = day.toISOString().split('T')[0];
                        const dayLogs = logs[dateStr] || {};
                        weekXP += Object.values(dayLogs).reduce((sum, p) => sum + p, 0);
                    }
                    if (weekXP > bestWeek.value) {
                        const weekEnd = new Date(d);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        bestWeek = {
                            value: weekXP,
                            date: `w/e ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                        };
                    }
                }
            }

            // Monthly record
            let bestMonth = { value: 0, date: '' };
            const months = {};
            for (const date of allDates) {
                const monthKey = date.slice(0, 7); // "YYYY-MM"
                const xp = Object.values(logs[date]).reduce((sum, p) => sum + p, 0);
                months[monthKey] = (months[monthKey] || 0) + xp;
            }
            for (const [monthKey, xp] of Object.entries(months)) {
                if (xp > bestMonth.value) {
                    const d = new Date(monthKey + '-01T00:00:00');
                    bestMonth = {
                        value: xp,
                        date: d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                    };
                }
            }

            return { daily: bestDay, weekly: bestWeek, monthly: bestMonth };
        }

        function switchAnalyticsView(view) {
            currentAnalyticsView = view;
            renderAnalytics();
        }

        function renderChart(logs) {
            let data = [];
            const today = new Date();

            if (currentAnalyticsView === 'daily') {
                // Last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const dayLogs = logs[dateStr] || {};
                    const xp = Object.values(dayLogs).reduce((sum, p) => sum + p, 0);
                    data.push({
                        label: date.toLocaleDateString('en-US', { weekday: 'short' }),
                        value: xp
                    });
                }
            } else if (currentAnalyticsView === 'weekly') {
                // Last 8 weeks
                for (let i = 7; i >= 0; i--) {
                    const weekEnd = new Date(today);
                    weekEnd.setDate(weekEnd.getDate() - (i * 7));
                    const weekStart = new Date(weekEnd);
                    weekStart.setDate(weekStart.getDate() - 6);
                    
                    let weekXP = 0;
                    for (let d = new Date(weekStart); d <= weekEnd; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toISOString().split('T')[0];
                        const dayLogs = logs[dateStr] || {};
                        weekXP += Object.values(dayLogs).reduce((sum, p) => sum + p, 0);
                    }
                    
                    data.push({
                        label: `W${8-i}`,
                        value: weekXP
                    });
                }
            } else {
                // Last 6 months
                for (let i = 5; i >= 0; i--) {
                    const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthEnd = new Date(month.getFullYear(), month.getMonth() + 1, 0);
                    
                    let monthXP = 0;
                    for (let d = new Date(month); d <= monthEnd; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toISOString().split('T')[0];
                        const dayLogs = logs[dateStr] || {};
                        monthXP += Object.values(dayLogs).reduce((sum, p) => sum + p, 0);
                    }
                    
                    data.push({
                        label: month.toLocaleDateString('en-US', { month: 'short' }),
                        value: monthXP
                    });
                }
            }

            const maxValue = Math.max(...data.map(d => d.value), 1);
            
            let chartHTML = '<div class="chart-container"><div class="chart-bars">';
            for (const item of data) {
                const height = (item.value / maxValue) * 100;
                chartHTML += `<div class="chart-bar" style="height: ${height}%">
                    ${item.value > 0 ? `<div class="chart-value">${item.value}</div>` : ''}
                    <div class="chart-label">${item.label}</div>
                </div>`;
            }
            chartHTML += '</div></div>';

            document.getElementById('chartContainer').innerHTML = chartHTML;
        }

        function renderHistory() {
            const logs = getLogs();
            const behaviors = getBehaviors();
            
            // Get all behavior names by ID
            const behaviorNames = {};
            for (const category of CATEGORIES) {
                const categoryBehaviors = behaviors[category] || [];
                for (const behavior of categoryBehaviors) {
                    behaviorNames[behavior.id] = behavior.name;
                }
            }

            const dates = Object.keys(logs).sort().reverse();
            
            let html = '<div class="card">';
            
            if (dates.length === 0) {
                html += `<div class="empty-state">No history yet</div>`;
            } else {
                for (const date of dates) {
                    const dayLogs = logs[date];
                    const xp = Object.values(dayLogs).reduce((sum, p) => sum + p, 0);
                    const behaviorList = Object.keys(dayLogs)
                        .map(id => behaviorNames[id] || 'Unknown')
                        .join(', ');

                    const dateObj = new Date(date + 'T00:00:00');
                    const formattedDate = dateObj.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });

                    html += `<div class="history-item">
                        <div>
                            <div class="history-date">${formattedDate}</div>
                            <div class="history-behaviors">${behaviorList}</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div class="history-xp">${xp} XP</div>
                            <button class="edit-btn" onclick="openEditLog('${date}')">Edit</button>
                        </div>
                    </div>`;
                }
            }
            
            html += '</div>';
            document.getElementById('historyView').innerHTML = html;
        }

        function openEditLog(date) {
            editingDate = date;
            const logs = getLogs();
            const behaviors = getBehaviors();
            const dayLogs = logs[date] || {};

            const dateObj = new Date(date + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                month: 'long', 
                day: 'numeric',
                year: 'numeric'
            });

            let html = `<div style="margin-bottom: 16px; color: #666;">${formattedDate}</div>`;

            for (const category of CATEGORIES) {
                const categoryBehaviors = behaviors[category] || [];
                if (categoryBehaviors.length === 0) continue;

                html += `<div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">${category}</div>`;

                for (const behavior of categoryBehaviors) {
                    const isLogged = dayLogs[behavior.id] !== undefined;
                    html += `<div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0;">
                        <div>
                            <div style="font-weight: 500;">${behavior.name}</div>
                            <div style="font-size: 12px; color: #667eea;">+${behavior.points} XP</div>
                        </div>
                        <input type="checkbox" 
                               id="edit_${behavior.id}" 
                               ${isLogged ? 'checked' : ''}
                               data-behavior-id="${behavior.id}"
                               data-points="${behavior.points}"
                               style="width: 20px; height: 20px; cursor: pointer;">
                    </div>`;
                }

                html += `</div>`;
            }

            document.getElementById('editLogContent').innerHTML = html;
            document.getElementById('editLogModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editLogModal').classList.remove('active');
        }

        function saveLogEdit() {
            const logs = getLogs();
            const checkboxes = document.querySelectorAll('#editLogContent input[type="checkbox"]');
            
            logs[editingDate] = {};
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const behaviorId = checkbox.dataset.behaviorId;
                    const points = parseInt(checkbox.dataset.points);
                    logs[editingDate][behaviorId] = points;
                }
            });

            saveLogs(logs);
            closeEditModal();
            renderHistory();
            if (currentTab === 'today' && editingDate === getTodayString()) {
                renderToday();
            }
        }

        function exportData() {
            const data = {
                behaviors: getBehaviors(),
                logs: getLogs(),
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `xp-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.behaviors && data.logs) {
                        saveBehaviors(data.behaviors);
                        saveLogs(data.logs);
                        alert('Data imported successfully!');
                        renderSettings();
                        if (currentTab === 'today') renderToday();
                    } else {
                        alert('Invalid backup file format');
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            localStorage.removeItem('xp_behaviors');
            localStorage.removeItem('xp_logs');
            initStorage();
            alert('All data cleared!');
            renderSettings();
            if (currentTab === 'today') renderToday();
        }

        function renderSettings() {
            const behaviors = getBehaviors();
            const logs = getLogs();
            
            const behaviorCount = Object.values(behaviors).reduce((sum, cats) => sum + cats.length, 0);
            const logCount = Object.keys(logs).length;
            const totalXP = Object.values(logs).reduce((sum, dayLogs) => {
                return sum + Object.values(dayLogs).reduce((s, points) => s + points, 0);
            }, 0);

            const html = `
                <div class="card">
                    <div class="category-header">
                        <div class="category-name">Data Management</div>
                    </div>
                    
                    <div style="padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
                        <div style="font-weight: 600; margin-bottom: 8px;">Your Data</div>
                        <div style="font-size: 13px; color: #666; line-height: 1.6;">
                            • ${behaviorCount} behaviors<br>
                            • ${logCount} days logged<br>
                            • ${totalXP} total XP earned
                        </div>
                    </div>

                    <div style="padding: 20px 0;">
                        <button class="btn btn-primary" onclick="exportData()" style="width: 100%; margin-bottom: 12px;">
                            Export Backup (Download JSON)
                        </button>
                        <button class="btn btn-primary" onclick="importData()" style="width: 100%; margin-bottom: 12px;">
                            Import Backup (Restore)
                        </button>
                        <button class="btn btn-secondary" onclick="clearAllData()" style="width: 100%; background: #d66; color: white;">
                            Clear All Data
                        </button>
                    </div>

                    <div style="padding: 12px 0; border-top: 1px solid #f0f0f0;">
                        <div style="font-size: 12px; color: #999; line-height: 1.6;">
                            <strong>iOS Storage Note:</strong> iOS may clear app data when storage is low. 
                            Export your backup regularly and save it to Files or iCloud to prevent data loss.
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('settingsView').innerHTML = html;
        }

        // Initialize app
        (function init() {
            initStorage();
            renderToday();
            
            // Setup import file handler
            document.getElementById('importFile').addEventListener('change', handleImport);
        })();
    </script>
</body>
</html>
